services:
  api:
    build:
      context: ./api
      dockerfile: Dockerfile.dev
    ports:
      - "8080:8080"
    volumes:
      - ./api:/app
      - go-modules:/go/pkg/mod
    env_file:
      - .env
    environment:
      - FIRESTORE_EMULATOR_HOST=firebase:8081
      - FIREBASE_AUTH_EMULATOR_HOST=firebase:9099
      - STORAGE_EMULATOR_HOST=firebase:9199
      - ENVIRONMENT=development
      - RESEND_API_KEY=${RESEND_API_KEY:-}
      - RESEND_FROM_EMAIL=${RESEND_FROM_EMAIL:-noreply@traceo.me}
      - GEMINI_API_KEY=${GEMINI_API_KEY:-}
      - TELEGRAM_BOT_TOKEN=${TELEGRAM_BOT_TOKEN:-}
      - TELEGRAM_CHAT_ID=${TELEGRAM_CHAT_ID:-}
    depends_on:
      firebase:
        condition: service_healthy
    networks:
      - traceo-net

  web:
    build:
      context: ./web
      dockerfile: Dockerfile.dev
    ports:
      - "5173:5173"
    volumes:
      - ./web:/app
      - web-node-modules:/app/node_modules
    environment:
      - VITE_API_URL=http://localhost:8080
      - VITE_FIREBASE_PROJECT_ID=traceo-dev
      - VITE_FIREBASE_API_KEY=fake-api-key
      - VITE_FIREBASE_AUTH_DOMAIN=localhost
      - VITE_GOOGLE_MAPS_API_KEY=${VITE_GOOGLE_MAPS_API_KEY:-}
    depends_on:
      - api
    networks:
      - traceo-net

  firebase:
    build:
      context: ./firebase
      dockerfile: Dockerfile
    ports:
      - "4000:4000"
      - "8081:8081"
      - "9099:9099"
      - "9199:9199"
    volumes:
      - ./firebase:/firebase
      - firebase-data:/firebase/data
    command: >
      firebase emulators:start --project traceo-dev --import=/firebase/data --export-on-exit=/firebase/data
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:4000"]
      interval: 5s
      timeout: 3s
      retries: 20
      start_period: 30s
    networks:
      - traceo-net

networks:
  traceo-net:
    driver: bridge

volumes:
  go-modules:
  web-node-modules:
  firebase-data:
